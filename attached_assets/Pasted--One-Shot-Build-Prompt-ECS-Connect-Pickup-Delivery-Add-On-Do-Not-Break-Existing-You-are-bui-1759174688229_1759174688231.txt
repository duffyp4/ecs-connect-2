# One-Shot Build Prompt — ECS Connect: Pickup & Delivery Add-On (Do Not Break Existing)

You are building the **Pickup & Delivery** functionality for **ECS Connect** on top of the existing system that already:
- Lets a **CSR create a Job** and **dispatch the existing GoCanvas “Emissions Service Log”** to the assignee.
- Stores Jobs and shows status/metrics.
- Tracks technician submissions from the **Emissions Service Log** (we do **not** change the technician workflow).

Your work must **add** pickup/delivery flows while **preserving all current behavior** and data.

---

## 0) Goal & Non-Goals
**Goal:** Enable end-to-end Job tracking from **pickup request or shop drop-off** to **ready for pickup/delivery**, and (when ECS is responsible) to **delivered**, with clear boards and KPIs.

**Non-Goals:** Do **not** change the tech section of the Emissions Service Log; do **not** change existing CSR check-in mapping; do **not** change PDFs/emails generated by GoCanvas for tech work.

---

## 1) States, Events, Rules
**States (columns):**  
Queued for Pickup → Picked Up → At Shop → In Service → Ready for Pickup/Delivery → Out for Delivery → Delivered

**Events:**  
pickup_requested, pickup_dispatched, picked_up, shop_checkin, tech_start, tech_complete, invoiced, ready_for_pickup, delivery_dispatched, delivered

**Rules:**  
- **Possession start** = earlier of *(picked_up, shop_checkin)*.  
- If **customer self-picks up**, ECS turnaround ends at **Ready for Pickup** (Job can remain visible but SLA stops).  
- If **ECS delivers**, turnaround ends at **Delivered**.

---

## 2) Features to Build (Product Surfaces)
**A) CSR: Job Create & Details**  
- Add **“Pickup requested?”** toggle (default now; editable).  
- Show a **Job Timeline** with events + timestamps + actor.  
- **Action buttons on Job** (enable/disable contextually):  
  - **Dispatch Pickup** (ECS-owned pickup)  
  - **Check-in from Pickup** (prefill Emissions Service Log check-in from pickup data)  
  - **Mark Ready for Pickup** (customer self-pickup path)  
  - **Dispatch Delivery** (ECS-owned delivery)

**B) Ops Dashboard (Boards)**  
- Columns: *Queued for Pickup, Picked Up, At Shop, In Service, Ready for Pickup/Delivery, Out for Delivery, Delivered*.  
- Each card: Job ID, customer, scenario badge (*Pickup+Delivery*, *Drop-off + Self-Pickup*, *Drop-off + Delivery*, *Delivery-only*), **age in state**.

**C) Driver Forms (GoCanvas) — with dynamic mapping requirements**  
- **Two separate forms are used:**  
  - **Pickup Log**: **Form ID `5628229`**  
  - **Delivery Log**: **Form ID `5604777`**
- For **each** form you must implement the **same dynamic field-mapping functionality** that exists today for the Emissions Service Log:  
  - Ability to **pull the latest form schema** from GoCanvas via API and **(re)generate field mappings** automatically when a form ID changes.  
  - Ability to **create dispatches** that populate the form’s **Dispatch Form** section fields from ECS Connect.  
- **Dispatch Form section to replicate:** For both forms, the subset of fields that must be filled from ECS Connect is the contiguous section that **starts with “job ID” and ends with “notes to driver.”** Ensure those fields are present, correctly mapped, and prefilled on dispatch.  
- **Required on both forms (beyond the Dispatch Form subset):** **ECS Job ID**, address, contact name/phone, notes (optional), **auto timestamp**, **auto GPS**, photos (optional).  
- All **dispatch payloads** must include the **ECS Job ID** so submissions link to the correct Job.

**D) Reporting (Read-Only)**  
- Weekly KPIs: **Time to Pickup**, **Time at Shop**, **Time with Tech**, **Total Turnaround**, plus SLA hit rates (only for ECS-owned legs).  
- Basic export (CSV).

---

## 3) Acceptance Criteria (A/C)
**Create Job & Placement**
- Creating a job with **Pickup requested = Yes** places it in **Queued for Pickup** and logs **pickup_requested** with timestamp.  
- Creating a job with **Pickup requested = No** and **Shop Check-in** logs **shop_checkin** and places it in **At Shop**.

**Pickup Flow**
- Clicking **Dispatch Pickup** records **pickup_dispatched** and (in live mode) creates a GoCanvas dispatch **to Form ID 5628229**, prefilled for the **Dispatch Form** fields (“job ID” → “notes to driver”).  
- On pickup submission (simulated or live), a **picked_up** event is created with timestamp/GPS, and the Job moves to **Picked Up**; **possession start** is set if not already.

**Check-in & Tech Flow**
- **Check-in from Pickup** logs **shop_checkin** and moves Job to **At Shop**.  
- Tech start/complete events move the Job **At Shop → In Service → Ready for Pickup/Delivery**; PDFs continue to arrive as today.

**Ready, Delivery, Done**
- **Mark Ready for Pickup** logs **ready_for_pickup** and **stops ECS turnaround clock** for self-pickup scenarios.  
- **Dispatch Delivery** logs **delivery_dispatched** and (in live mode) creates a GoCanvas dispatch **to Form ID 5604777**, prefilled for the **Dispatch Form** fields (“job ID” → “notes to driver”).  
- A delivery submission logs **delivered** and moves Job to **Delivered**.

**KPIs**
- **Time to Pickup** = picked_up − pickup_requested *(only when ECS handles pickup)*.  
- **Time at Shop** = ready_for_pickup/delivery − possession_start.  
- **Time with Tech** = tech_complete − tech_start.  
- **Total Turnaround:**  
  - If ECS delivers: delivered − earliest(pickup_requested, shop_checkin).  
  - If customer self-picks up: ready_for_pickup − earliest(pickup_requested, shop_checkin).

---

## 4) Modes: Simulation First, Then Live
- Add a **feature flag**: **Driver Submissions Mode = Simulation | GoCanvas Live**.  
- **Simulation mode:** provide dev-only buttons on Job Detail to create **picked_up** and **delivered** events.  
- **Live mode:** use the GoCanvas API to **pull the Pickup (5628229) and Delivery (5604777) form schemas**, keep a local field map, **prefill the Dispatch Form section (“job ID” → “notes to driver”)** on dispatch, and **ingest submissions**; match by **ECS Job ID**; create events; hide simulation buttons.

---

## 5) Data Threading (Must-Haves)
- **ECS Job ID** appears in: CSR Job, dispatch payloads, field(s) in Pickup/Delivery forms, and Emissions Service Log dispatch.  
- Every submission/event references the same **ECS Job ID**.

---

## 6) Fixtures for Demo/QA
Seed 5 sample Jobs covering:  
1. Full courier loop (pickup + delivery)  
2. Drop-off + self-pickup  
3. Drop-off + ECS delivery  
4. Delivery-only  
5. Pickup-only (self-pickup after service)

Provide one-click **Reset Demo Data**.

---

## 7) Observability
- Log: dispatch created, form schema fetched/updated, field map regenerated, submission ingested, state change, KPI recompute.  
- A small **Diagnostics** view listing the last 50 events with filters by Job ID and event type.

---

## 8) Artifacts to Produce in This One-Shot
- Updated **Job Create** and **Job Detail** screens with new buttons and timeline.  
- **Boards** with all columns and card summaries.  
- **Reporting** view with KPI definitions rendered and sample data.  
- **Dev Tools** panel: Simulation vs Live toggle; simulate pickup/delivery; reset demo data.  
- **GoCanvas integration shims** that:  
  - Fetch schemas for **5628229** (Pickup) and **5604777** (Delivery) and (re)generate field maps.  
  - Create dispatches prefilled for the **Dispatch Form** subset (“job ID” → “notes to driver”).  
  - Ingest submissions and attach them to Jobs by **ECS Job ID**.  
- A short **README** describing flows, the feature flag, form IDs, the Dispatch Form subset, and test steps for the 5 seeded scenarios.

---

## 9) Guardrails
- Do not alter existing Emissions Service Log technician workflow or PDFs.  
- Preserve all existing CSR mappings and APIs; only **extend** with new actions and views.  
- Buttons should be **context-aware** (e.g., don’t show “Dispatch Delivery” before Ready).  
- All time math must use the event timestamps stated above.  
- The GoCanvas schema pull + field-map regeneration must be **idempotent** and safe to run when form IDs change.

**Deliver all of the above in a running app that supports both Simulation and Live modes without changing the UX.**
